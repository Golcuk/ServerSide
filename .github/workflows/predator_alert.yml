name: Predator Alert

on:
  push:
    paths:
      - 'imgs/**'

jobs:
  notify_firebase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Firebase Admin
        run: pip install firebase-admin

      - name: Send Notification
        env:
          FIREBASE_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          python -c "
          import os
          import json
          import firebase_admin
          from firebase_admin import credentials, messaging

          # Initialize
          key_json = os.environ['FIREBASE_KEY']
          cred = credentials.Certificate(json.loads(key_json))
          firebase_admin.initialize_app(cred)

          # Send Alert
          msg = messaging.Message(
              notification=messaging.Notification(
                  title='Predator Alert',
                  body='New activity detected on the farm.'
              ),
              topic='farm_alerts'
          )
          
          try:
              response = messaging.send(msg)
              print('SUCCESS: Notification sent.')
          except Exception as e:
              print(f'ERROR: {e}')
              exit(1)
          "
