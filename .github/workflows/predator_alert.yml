name: Predator Alert

on:
  push:
    paths:
      - 'farms/*/images/**'

jobs:
  notify_firebase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Firebase Admin
        run: pip install firebase-admin

      - name: Send Notification
        env:
          FIREBASE_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          python -c "
          import os
          import json
          import glob
          import re
          from datetime import datetime
          import firebase_admin
          from firebase_admin import credentials, messaging

          # Pattern to find images in ANY farm folder
          files = glob.glob('farms/*/images/*.jpg') + glob.glob('farms/*/images/*.png')
          
          def parse_time(filename):
              match = re.search(r'_(\d{8})_(\d{6})', filename)
              if match:
                  dt_str = match.group(1) + match.group(2)
                  return datetime.strptime(dt_str, '%Y%m%d%H%M%S')
              return datetime.min

          file_data = []
          for f in files:
              file_data.append((parse_time(f), f))
          
          file_data.sort(key=lambda x: x[0], reverse=True)

          if not file_data:
              print('No images found.')
              exit(0)

          newest_time = file_data[0][0]
          newest_file = file_data[0][1]

          parts = newest_file.split('/')
          farm_id = parts[1] if len(parts) > 1 else 'Unknown Farm'
          
          filename_only = os.path.basename(newest_file)
          animal_parts = filename_only.split('_')
          animal = 'Unknown Predator'
          if len(animal_parts) >= 2:
               animal = animal_parts[1] 

          print(f'Detected: {animal} at {farm_id}')

          if len(file_data) >= 2:
              previous_time = file_data[1][0]
              diff = (newest_time - previous_time).total_seconds()
              
              if diff < 10:
                  print(f'ðŸš« SKIPPING: Burst ({diff}s).')
                  exit(0)

          key_json = os.environ['FIREBASE_KEY']
          cred = credentials.Certificate(json.loads(key_json))
          firebase_admin.initialize_app(cred)

          # --- KEY CHANGE HERE ---
          # We added 'imageName' to data so the app can build the URL
          msg = messaging.Message(
              notification=messaging.Notification(
                  title='Predator Alert',
                  body=f'There is a {animal} spotted in {farm_id}!'
              ),
              data={
                  'farmId': farm_id,
                  'animal': animal,
                  'timestamp': str(newest_time),
                  'imageName': filename_only # <--- ADDED THIS
              },
              topic='farm_alerts'
          )
          
          try:
              response = messaging.send(msg)
              print('âœ… SUCCESS: Notification sent.')
          except Exception as e:
              print(f'ERROR: {e}')
              exit(1)
          "
